<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Barcode Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://unpkg.com/howler"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-gray-900">

  <!-- Header -->
  <div class="flex items-center justify-between p-4 bg-blue-600 text-white">
    <h1 class="text-lg font-bold">Scan Products</h1>
    <button onclick="clearAll()" class="text-sm">Clear all</button>
  </div>

  <!-- Scanner Area -->
  <div id="reader" class="mx-auto mt-4 w-[90%] rounded-lg overflow-hidden border-2 border-gray-200"></div>

  <!-- Items List -->
  <div class="fixed bottom-0 w-full bg-white shadow-lg">
    <div class="flex items-center justify-between px-4 pt-2 pb-1 border-t">
      <div class="font-medium text-gray-800"><span id="item-count">0</span> items</div>
      <button onclick="submitData()" class="text-blue-600 font-semibold">Submit</button>
    </div>
    <div id="item-list" class="max-h-52 overflow-y-auto px-4 pb-4"></div>
  </div>

  <!-- Beep Sound -->
  <audio id="beep" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

  <script>
    const scannedItems = {};
    const itemList = document.getElementById("item-list");
    const itemCount = document.getElementById("item-count");
    const beep = document.getElementById("beep");

    function playBeep() {
      beep.currentTime = 0;
      beep.play();
    }

    async function fetchProduct(barcode) {
      // Mock: replace with your actual API
      const response = await fetch(`https://your-api.com/product?barcode=${barcode}`);
      if (!response.ok) return null;
      return await response.json(); // Should return { name, price }
    }

    async function onScanSuccess(barcode) {
      if (scannedItems[barcode]) return;

      const product = await fetchProduct(barcode);
      if (!product) return alert("Product not found");

      scannedItems[barcode] = { ...product, quantity: 1 };
      playBeep();
      renderItems();
    }

    function renderItems() {
      itemList.innerHTML = "";
      const entries = Object.entries(scannedItems);
      itemCount.textContent = entries.length;

      for (const [barcode, { name, price, quantity }] of entries) {
        const item = document.createElement("div");
        item.className = "flex items-center justify-between py-2 border-b";
        item.innerHTML = `
          <div>
            <div class="font-semibold">${name}</div>
            <div class="text-sm text-gray-500">₹${price} • ${barcode}</div>
          </div>
          <div class="flex items-center space-x-2">
            <button onclick="updateQty('${barcode}', -1)" class="bg-gray-200 px-2 rounded">-</button>
            <span>${quantity}</span>
            <button onclick="updateQty('${barcode}', 1)" class="bg-gray-200 px-2 rounded">+</button>
          </div>
        `;
        itemList.appendChild(item);
      }
    }

    function updateQty(barcode, change) {
      if (!scannedItems[barcode]) return;
      scannedItems[barcode].quantity += change;
      if (scannedItems[barcode].quantity <= 0) delete scannedItems[barcode];
      renderItems();
    }

    function clearAll() {
      for (let key in scannedItems) delete scannedItems[key];
      renderItems();
    }

    function submitData() {
      const payload = Object.entries(scannedItems).map(([barcode, info]) => ({
        barcode,
        ...info
      }));
      console.log("Submitting:", payload);

      // Send to backend
      fetch("https://your-api.com/submit", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(res => alert("Submitted!")).catch(err => alert("Error"));
    }

    // Initialize Scanner
    const scanner = new Html5QrcodeScanner("reader", {
      fps: 10,
      qrbox: { width: 250, height: 100 },
      disableFlip: true,
      rememberLastUsedCamera: true
    });

    scanner.render(onScanSuccess);
  </script>
</body>
</html>
